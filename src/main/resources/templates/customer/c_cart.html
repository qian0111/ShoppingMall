<!-- de5e55 -->
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<title>buyall</title>
	<!-- ================= Favicon ================== -->
	<!-- Standard -->
	<link rel="shortcut icon" href="http://placehold.it/64.png/000/fff">
	<!-- Retina iPad Touch Icon-->
	<link rel="apple-touch-icon" sizes="144x144" href="http://placehold.it/144.png/000/fff">
	<!-- Retina iPhone Touch Icon-->
	<link rel="apple-touch-icon" sizes="114x114" href="http://placehold.it/114.png/000/fff">
	<!-- Standard iPad Touch Icon-->
	<link rel="apple-touch-icon" sizes="72x72" href="http://placehold.it/72.png/000/fff">
	<!-- Standard iPhone Touch Icon-->
	<link rel="apple-touch-icon" sizes="57x57" href="http://placehold.it/57.png/000/fff">
	<!-- Styles -->
	<link rel="stylesheet" type="text/css" href="/sm/static/layui/css/layui.css">
	<link href="/sm/static/css/fontawesome-all.min.css" rel="stylesheet">
	<link href="/sm/static/css/themify-icons.css" rel="stylesheet">
	<link href="/sm/static/css/mmc-chat.css" rel="stylesheet" />
	<link href="/sm/static/css/sidebar.css" rel="stylesheet">
	<link href="/sm/static/css/bootstrap.min.css" rel="stylesheet">
	<link href="/sm/static/css/nixon.css" rel="stylesheet">
	<link href="/sm/static/css/lobipanel.min.css" rel="stylesheet">
	<link href="/sm/static/css/style.css" rel="stylesheet">
	<style>
		.myabsolute{
			width: 200px;
			height: 133px;
		}
	</style>
</head>
<body>
	<div class="container" style="background-color: white">
		<div class="row clearfix">
			<div class="col-md-12 column">
				<div class="header">
					<div class="pull-left">
						<div class="logo">
							<a >
								<img id="logoImg" src="/sm/static/images/welcome.png"/>
							</a>
						</div>
					</div>
					<div class="pull-right p-r-15">
						<ul>
<!--							<li class="header-icon dib input-group input-group-default">-->
<!--								<input id="gName" type="text" th:value="${gName}" placeholder="查找购买过的商品" name="Search" class="form-control " style="height: 30px; width: 300px;">-->
<!--								<i class="ti-search" style="padding-left: 12px;" onclick="search()"></i>-->
<!--							</li>-->
							<span class="header-icon dib" style="width: 50px;"></span>
							<li class="header-icon dib">
								<i class="ti-shopping-cart"></i>
								<span class="user-avatar" href="">购物车</span>
							</li>
							<li class="header-icon dib">
								<i class="ti-clipboard"></i>
								<span class="user-avatar" href="">我的订单</span>
							</li>
							<li class="header-icon dib">
								<!-- <img class="avatar-img" src="img/avatar/1.jpg" alt="" /> -->
								<i class="ti-user"></i>
								<span class="user-avatar" th:text="${userName}">用户未登录</span>
							</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		<div class="row clearfix" style="width: 97%; padding-top:100px; padding-left: 60px; ">
			<div class="col-md-12 column">
				<div class="row clearfix">
					<div class="col-md-12 column"  th:each="cart:${cartList}">
						<div class="row clearfix">
							<div class="col-md-3 column">
								<img class="myabsolute" th:src="@{/static/images/}+${cart.gImage}" />
							</div>
							<div class="col-md-9 column">
								<div style="height: 30px;">
									<h1 style="font-size: 20px;color: rgba(12,12,12,0.89);" th:text="${cart.gName}"></h1>
								</div>
								<h1>
									<span style="font-size: 18px;color: rgba(12,12,12,0.89);" >单价：</span>
									<span style="font-size: 18px;color: rgba(12,12,12,0.89);" th:text="${cart.gPrice}+'￥'"></span>
									<span style="font-size: 18px;color: rgba(12,12,12,0.89);padding-left: 50px;">购买数量：</span>
									<span style="font-size: 18px;color: rgba(12,12,12,0.89);"th:text="${cart.buyCount}"></span>
									<span style="font-size: 18px;color: rgba(12,12,12,0.89);padding-left: 50px;">总价：</span>
									<span style="font-size: 18px; color: red;"th:text="${cart.totalPrice}+'￥'"></span>
									<span style="padding-left: 100px;"></span>
									<button type="button" class="btn btn-danger" th:onclick="'payNow('+${cart.buyCount}+','+${cart.gId}+','+ ${cart.uId}+')'">购买</button>
									<span style="padding-left: 10px;"></span>
									<button type="button" class="btn btn-danger" th:onclick="'delCart('+${cart.gId}+','+ ${cart.uId}+')'">删除</button>
								</h1>									
							</div>
						</div>
						<hr>
					</div>
				</div>
			</div>
			<hr>
		</div>
	</div>
</body>
<script src="/sm/static/js/jquery-1.9.1.min.js"></script>
<!-- /# content wrap -->
<script src="/sm/static/js/jquery.min.js"></script>
<!-- jquery vendor -->
<script src="/sm/static/js/jquery.nanoscroller.min.js"></script>
<!-- nano scroller -->
<script src="/sm/static/js/sidebar.js"></script>

<script src="/sm/static/js/bootstrap.min.js"></script>
<!-- bootstrap -->
<script src="/sm/static/js/mmc-common.js"></script>
<script src="/sm/static/js/mmc-chat.js"></script>
<!-- Chart js -->
<script src="/sm/static/js/Chart.bundle.js"></script>
<script src="/sm/static/js/chartjs-init.js"></script>
<!-- // Chart js -->
<!--  Datamap -->
<script src="/sm/static/js/d3.min.js"></script>
<script src="/sm/static/js/topojson.js"></script>
<script src="/sm/static/js/datamaps.world.min.js"></script>
<script src="/sm/static/js/datamap-init.js"></script>
<script src="/sm/static/js/lobipanel.js"></script>
<!-- // Datamap -->
<script src="/sm/static/js/scripts.js"></script>
<script src="/sm/static/layui/layui.js"></script>
<script type="text/javascript" th:inline="javascript">
	layui.use('layer', function(){
		var layer = layui.layer;
	});
	function payNow(buyCount, gId, uId){
		layer.open({
			skin: 'demo-class',
			type: 2,
			area: ['300px', '180px'],
			content: "passPage",
			btn: ['支付'],
			btnAlign: 'c',
			yes: function(index){
				//获取弹层返回值
				var res = window["layui-layer-iframe" + index].callbackdata();
				var orderNo;
				//调用下单方法
				$.ajax({
					url:'generateOrder',
					async: false,
					data:{"buyCount":buyCount, "gId":gId, "uId":uId},
					type:"POST",
					success:function(str){//请求成功之后的回调函数，接收服务端响应的数据
						if(str === "0"){
							//库存不足，关闭弹窗
							layer.close(index);
							alert("库存不足");
						}
						else{
							orderNo = str;
						}
					},
					error:function(){//请求失败之后的回调函数

					}
				});
				if(orderNo == null){
					return;
				}
				var pay_res = pay(res, orderNo);
				console.info(pay_res);
				if(pay_res == 1){
					//从购物车清除
					$.ajax({
						url:'delCart',
						async: false,
						data:{"gId":gId, "uId":uId},
						type:"POST",
						success:function(str){//请求成功之后的回调函数，接收服务端响应的数据

						},
						error:function(){//请求失败之后的回调函数

						}
					});
					layer.close(index);
					setTimeout(function() {location.reload()}, 100);
				} else {
					window.location.href = "orderPage?uId=" + uId;
				}
			}
		});
	}
	function pay(userPass, orderNo){
		var code;
		//向服务端发送支付请求
		$.ajax({
			url: "afterPay",
			data: {"userPass":userPass, "uId":[[${uId}]], "orderNo":orderNo},
			dataType: "json",
			type: "post",
			async: false,
			success:function(res){
				alert(res.msg);
				code = res.code;
			}
		});
		return code;
	}

	function delCart(gId, uId){
		//从购物车清除
		$.ajax({
			url:'delCart',
			async: false,
			data:{"gId":gId, "uId":uId},
			type:"POST",
			success:function(str){//请求成功之后的回调函数，接收服务端响应的数据
				if(str.code == 1){
					alert("删除成功");
				}
				else {
					alert("删除失败");
				}
			},
			error:function(){//请求失败之后的回调函数
			}
		});
		setTimeout(function() {location.reload()}, 100);
	}
</script>
</html>
